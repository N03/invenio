/*
 * This file is part of Invenio.
 * Copyright (C) 2015 CERN.
 *
 * Invenio is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as
 * published by the Free Software Foundation; either version 2 of the
 * License, or (at your option) any later version.
 *
 * Invenio is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Invenio; if not, write to the Free Software Foundation, Inc.,
 * 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.
 *
 * In applying this license, CERN does not
 * waive the privileges and immunities granted to it by virtue of its status
 * as an Intergovernmental Organization or submit itself to any jurisdiction.
 */
!function(e){function n(n,r,t){function i(){return r.get()}function a(){function e(){g.invenioSearchLoading=!1,n.$broadcast("invenio.search.finished")}function r(e){n.$broadcast("invenio.search.success",e)}function i(e){n.$broadcast("invenio.search.error",e)}n.$broadcast("invenio.search.requested"),g.invenioSearchLoading=!0,g.invenioSearchError={},g.invenioSearchErrorsResults={},t.search(g.invenioSearchCurrentArgs,g.invenioSearchHiddenParams).then(r,i).finally(e)}function o(e){for(var n=(e.split("?")[1]||"").split("&"),r={},t=0;t<n.length;t+=1){var i=(n[t]||"").split("="),a=decodeURIComponent(i[0]||"");a&&(r[a]=decodeURIComponent(i[1]||""))}return r}function c(e,n){g.invenioSearchErrorResults=n.data,g.invenioSearchError=e}function s(n,r){if(g.invenioSearchResults=r.data,g.invenioSearchErrorResults={},r.data.links){var t=o(r.data.links.self);t.page&&(t.page=parseInt(t.page)),t.size&&(t.size=parseInt(t.size)),delete t.q,e.equals(g.invenioSearchCurrentArgs,t)||(g.invenioSearchSortArgs=t)}}function l(t,i){g.invenioSearchCurrentArgs=e.merge({},g.invenioSearchCurrentArgs,i),g.invenioSearchArgs=e.merge({},g.invenioSearchCurrentArgs.params),r.set(g.invenioSearchArgs),r.replace(),g.userQuery=g.invenioSearchArgs.q,g.invenioSearchInitialized=!0,g.invenioDoSearch(),n.$broadcast("invenio.search.initialiazed")}function h(n,t,i){void 0!==i&&i===!0?g.invenioSearchCurrentArgs.params=e.copy(t):(g.invenioSearchCurrentArgs.params.page===t.page&&(t.page=1),e.forEach(t,function(e,n){g.invenioSearchCurrentArgs.params[n]=e})),g.invenioSearchArgs=e.copy(g.invenioSearchCurrentArgs.params),r.set(g.invenioSearchCurrentArgs.params),g.userQuery=g.invenioSearchArgs.q,g.invenioDoSearch()}function u(){var t=r.get();e.equals(t,g.invenioSearchCurrentArgs.params)||n.$broadcast("invenio.search.request",t,!0)}function d(r,t){var i=e.copy(g.invenioSearchCurrentArgs.params);e.forEach(t,function(n,r){i[r]=e.copy(t[r])}),e.equals(g.invenioSearchCurrentArgs.params,i)||n.$broadcast("invenio.search.request",i)}function v(r){e.equals(r,g.invenioSearchCurrentArgs.params)||n.$broadcast("invenio.search.request",r)}var g=this;g.invenioSearchResults={},g.invenioSearchErrorResults={},g.invenioSearchLoading=!0,g.invenioSearchError={},g.invenioSearchInitialized=!1,g.invenioSearchArgs={},g.invenioSearchSortArgs={},g.invenioSearchCurrentArgs={method:"GET",params:{page:1,size:20}},g.invenioSearchGetUrlArgs=i,g.invenioDoSearch=a,g.parseURLQueryString=o,n.$on("invenio.search.initialazation",l),n.$on("invenio.search.request",h),n.$on("invenio.search.success",s),n.$on("invenio.search.error",c),n.$on("invenio.search.params.change",d),n.$on("$locationChangeStart",u),n.$watch("vm.invenioSearchArgs",v,!0)}function r(){function n(n,r,t,i){var a={url:t.searchEndpoint,method:t.searchMethod||"GET",headers:JSON.parse(t.searchHeaders||"{}")},o={params:JSON.parse(t.searchExtraParams||"{}")},c={params:i.invenioSearchGetUrlArgs()};i.invenioSearchHiddenParams=JSON.parse(t.searchHiddenParams||"{}");var s=e.merge({},a,o,c);n.$broadcast("invenio.search.initialazation",s)}return{restrict:"AE",scope:!1,controller:"invenioSearchController",controllerAs:"vm",link:n}}function t(){function e(e,n,r,t){function i(){t.invenioSearchArgs.q=t.userQuery}e.placeholder=r.placeholder,e.updateQuery=i}function n(e,n){return n.template}return{restrict:"AE",require:"^invenioSearch",scope:!1,templateUrl:n,link:e}}function i(){function e(e,n,r){e.loadingMessage=r.message}function n(e,n){return n.template}return{restrict:"AE",require:"^invenioSearch",templateUrl:n,link:e}}function a(){function e(e,n,r){e.recordTemplate=r.recordTemplate}function n(e,n){return n.template}return{restrict:"AE",scope:!1,require:"^invenioSearch",templateUrl:n,link:e}}function o(){function e(e,n,r){e.errorMessage=r.message}function n(e,n){return n.template}return{restrict:"AE",scope:!1,require:"^invenioSearch",templateUrl:n,link:e}}function c(){function e(e,n){return n.template}return{restrict:"AE",scope:!1,require:"^invenioSearch",templateUrl:e}}function s(){function n(n,r,t,i){function a(r,t){n.handler[r]=void 0===n.handler[r]?[]:n.handler[r];var i=n.handler[r].indexOf(t);-1===i?n.handler[r].push(t):"string"==typeof n.handler[r]?n.handler[r]=[]:n.handler[r].splice(i,1);var a={};a[r]=e.copy(n.handler[r]),n.$broadcast("invenio.search.params.change",a)}function o(e){return"string"==typeof n.handler[e]?[n.handler[e]]:n.handler[e]}n.handler=e.copy(i.invenioSearchCurrentArgs.params),n.$on("invenio.search.finished",function(){n.handler=e.copy(i.invenioSearchCurrentArgs.params)}),n.handleClick=a,n.getValues=o}function r(e,n){return n.template}return{restrict:"AE",scope:!1,require:"^invenioSearch",templateUrl:r,link:n}}function l(){function e(e,n,r,t){function i(n,r){for(var t=(c(),function(e){return{value:e,title:"Go to page "+e}}),i=n;r>=i;i++){var a=t(i);e.paginatePages.push(a)}}function a(){e.paginatePages=[];var n,r,t=e.adjacentSize,a=o(),s=c(),l=2*t;l+2>=a?(n=1,i(n,a)):2>=s-t?(n=1,r=1+l,i(n,r)):a-(t+2)>s?(n=s-t,r=s+t,i(n,r)):(n=a-l,r=a,i(n,r))}function o(){var e;try{e=t.invenioSearchResults.hits.total}catch(n){e=0}return Math.ceil(e/t.invenioSearchArgs.size)}function c(){return parseInt(t.invenioSearchArgs.page)||1}function s(){var e=c(),n=o();return n>e&&(e+=1),e}function l(){{var e=c();o()}return e>1&&(e-=1),e}function h(e){return e===c()?"active":""}function u(){return c()<o()?"":"disabled"}function d(){return c()>1?"":"disabled"}function v(){return 1!==c()?"":"disabled"}function g(){return c()!==o()?"":"disabled"}function p(e){t.invenioSearchArgs.page=e>o()?o():1>e?1:e}e.paginatePages=[],e.adjacentSize=r.adjacentSize||4,e.showGoToFirstLast=r.showGoToFirstLast||!1,e.$watch("vm.invenioSearchArgs.page",function(e,n){e!==n&&a()}),e.$watch("vm.invenioSearchResults",function(){a()}),e.paginationHelper={changePage:p,current:c,getFirstClass:v,getLastClass:g,getNextClass:u,getPageClass:h,getPrevClass:d,next:s,pages:a,previous:l,total:o}}function n(e,n){return n.template}return{restrict:"AE",scope:!1,require:"^invenioSearch",templateUrl:n,link:e}}function h(){function e(e,n,r,t){function i(n){var r=t.invenioSearchArgs[e.data.sortKey]||t.invenioSearchSortArgs[e.data.sortKey]||"";return"-"===r.charAt(0)&&(r=r.slice(1,r.length)),"-"===n.charAt(0)&&(n=n.slice(1,n.length)),r===n||!1}function a(){t.invenioSearchArgs[e.data.sortKey]=e.data.selectedOption}function o(n){if(n){var r=e.data.selectedOption;"-"===r.charAt(0)&&(r=r.slice(1,r.length));var t=null;t="-"===n.charAt(0)?n.slice(1,n.length):n,r!==t&&(e.data.selectedOption=n)}}e.data={availableOptions:JSON.parse(r.availableOptions||"{}"),selectedOption:t.invenioSearchArgs[r.sortKey]||null,sortKey:r.sortKey||"sort"},null===e.data.selectedOption&&(e.data.selectedOption=e.data.availableOptions.options[0].value),e.isSelected=i,e.handleFieldChange=a,e.$watchCollection("vm.invenioSearchSortArgs."+e.data.sortKey,o),e.$watchCollection("vm.invenioSearchArgs."+e.data.sortKey,o)}function n(e,n){return n.template}return{restrict:"AE",require:"^invenioSearch",templateUrl:n,link:e}}function u(){function n(n,r,t,i){function a(r,t){var a={};a[r]=t||null,i.invenioSearchArgs=e.merge(i.invenioSearchArgs,a),n.whichOrder="-"!==(t||"").charAt(0)?"asc":"desc"}function o(){var e=i.invenioSearchArgs[n.sortKey]||i.invenioSearchCurrentArgs[n.sortKey]||"";"-"===e.charAt(0)&&(e=e.slice(1,e.length)),"asc"===n.whichOrder?a(n.sortKey,e):"desc"===n.whichOrder&&a(n.sortKey,"-"+e)}function c(e){e&&(n.whichOrder="-"!==e.charAt(0)?"asc":"desc")}n.sortKey=t.sortKey,n.handleOrderChange=o,n.whichOrder="asc",n.$watchCollection("vm.invenioSearchSortArgs."+n.sortKey,c),n.$watchCollection("vm.invenioSearchArgs."+n.sortKey,c)}function r(e,n){return n.template}return{restrict:"AE",require:"^invenioSearch",templateUrl:r,link:n}}function d(n,r){function t(t,i,a,o){function c(e,n){if(!isNaN(e)&&!isNaN(n)){var r={},i={from:e,to:n},a=i.from+"--"+i.to;r[l.name]=a,t.$broadcast("invenio.search.params.change",r)}}function s(){if(u&&(l.width=h()||d),o.invenioSearchResults.aggregations){var e=o.invenioSearchResults.aggregations[l.name].buckets;if(e.length>0){if(o.invenioSearchArgs[l.name]){var r=o.invenioSearchArgs[l.name].split("--"),t=+r[0],i=2===r.length?+r[1]:t;isNaN(t)||isNaN(i)||(l.selectionRange={min:t,max:i})}n(l.histogramId,l.selectionId,e,l,c)}}}var l={height:70,name:"years",histogramId:"#hist",selectionId:"#select",margins:{left:10,right:10,top:10,bottom:0},barColor:"#2c3e50",selectColor:"#3498db",lineColor:"#ccc",circleColor:"white",padding:2},h=function(){var e=d3.select(l.histogramId).node();return e.getBoundingClientRect().width};e.merge(l,e.fromJson(a.options));var u=!l.width;if(u)var d=h();t.$on("invenio.search.finished",s),u&&e.element(r).bind("resize",s)}function i(e,n){return n.template}return{restrict:"AE",require:"^invenioSearch",templateUrl:i,link:t}}function v(n,r){function t(t,i){function a(e){c.resolve(e)}function o(e){c.reject(e)}var c=r.defer(),s=e.copy(t);return s.params=e.merge(s.params,i||{}),n(s).then(a,o),c.promise}return{search:t}}function g(e){function n(){return e.search()}function r(n){e.search(n)}function t(){e.replace()}return{get:n,replace:t,set:r}}function p(){function n(n,t,o,h,g){c=e.merge(h,c),r&&r.remove(),r=d3.select(n).append("svg").attr({width:c.width,height:c.height});var p=r.append("g").style("pointer-events","all"),f=d3.select("body").append("div").attr("class","range_tooltip").style({position:"absolute","text-align":"center",width:"40px",height:"18px",padding:"2px",font:"12px sans-serif",background:"lightblue",border:"0px","border-radius":"8px","pointer-events":"none",opacity:0});u(o);var m=d3.extent(o,function(e){return e.key});m[0]=m[0]-.1*o.length,m[1]=m[1]+.1*o.length,i=d3.scale.linear().domain(m).range([c.margins.left,c.width-c.margins.left-c.margins.right]);var S=Math.min(10,(c.width-c.margins.left-c.margins.right-o.length*c.padding)/(l-s));S=Math.max(1,S);var y=d3.max(o,function(e){return e.doc_count});a=d3.scale.linear().domain([0,y]).range([0,c.height-c.margins.bottom]);var A=p.selectAll(".bar").data(o).enter().append("g").attr("class","bar");console.log(S),A.append("rect").attr("height",function(e){return a(e.doc_count)}).attr("width",S).attr("x",function(e){return i(e.key)-S/2}).attr("y",function(e){return a.range()[1]-a(e.doc_count)}).style("fill",function(e){return e.selected?c.selectColor:c.barColor}),A.on("mouseenter",function(e){d3.select(this).select("rect").style("fill",d3.rgb(e.selected?c.selectColor:c.barColor).brighter()),f.transition().duration(200).style("opacity",.9),f.html(e.doc_count).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px")}).on("mouseout",function(e){d3.select(this).select("rect").style("fill",e.selected?c.selectColor:c.barColor),f.transition().duration(500).style("opacity",0)}).on("click",function(e){d([e.key,e.key]),d3.select(".resize.e").style("display","inline")}),v(n,t,g)}var r,t,i,a,o,c,s,l,h=[],u=function(e){e.forEach(function(e){e.key=+e.key_as_string,e.selected=c.selectionRange?e.key>=c.selectionRange.min&&e.key<=c.selectionRange.max:!0});var n=e.map(function(e){return e.key});s=Math.min.apply(void 0,n),l=Math.max.apply(void 0,n)},d=function(n){n=e.copy(n),n[0]===n[1]&&(n[1]+=1e-5),o.extent(n),o(d3.select(".brush").transition()),o.event(d3.select(".brush").transition())},v=function(e,n,r){t&&t.remove(),t=d3.select(n).append("svg").attr({width:c.width,height:35}).style("fill",c.selectColor).style("overflow","visible"),t.append("line").attr({x1:0,x2:c.width,y1:5.5,y2:5.5}).style({stroke:c.lineColor,"stroke-width":3});var a=function(){var e=o.extent().map(Math.round);e.some(isNaN)&&(e=[s,l]),d3.select(".brush-range.min").text(e[0]),d3.select(".brush-range.max").text(e[1]),h=[],d3.selectAll("g.bar").select("rect").style("fill",function(n){return n.selected=n.key>=e[0]&&n.key<=e[1],n.selected&&h.push(n.key),n.selected?c.selectColor:c.barColor})},u=[s,l];if(c.selectionRange){var v=parseInt(i.domain()[0]),g=parseInt(i.domain()[1]),p=c.selectionRange.min<v||c.selectionRange.min>g?v:c.selectionRange.min,f=c.selectionRange.max>g||c.selectionRange.max<v?g:c.selectionRange.max;u=[p,f]}o=d3.svg.brush().x(i).extent(u).on("brush",a).on("brushend",function(){var e;0===h.length?e=[s,l]:(e=o.extent().map(Math.round),e[0]=Math.max(e[0],s),e[1]=Math.min(e[1],l)),d(e),r.apply(void 0,e)}),t.append("g").attr("class","brush").call(o).selectAll("rect").attr("y",4).attr("height",3);var m=t.selectAll(".resize").append("g");m.append("circle").attr("r",5).attr("cx",0).attr("cy",6).style({"stroke-width":2,stroke:c.selectColor,fill:c.circleColor}),m.append("text").attr("text-anchor","middle").style("transform","rotate(-45deg) translateX(-15px)").text(function(e,n){return parseInt(o.extent()[0===n?1:0])}).attr("class",function(e,n){return"brush-range "+(0===n?"max":"min")}).attr("y",31),parseInt(u[0])===parseInt(u[1])&&d3.select(".resize.e").style("display","inline")};return n}function f(e){e.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}n.$inject=["$scope","invenioSearchHandler","invenioSearchAPI"],d.$inject=["invenioSearchRangeFactory","$window"],v.$inject=["$http","$q"],g.$inject=["$location"],f.$inject=["$locationProvider"],e.module("invenioSearch.configuration",[]).config(f),e.module("invenioSearch.services",[]).service("invenioSearchHandler",g).service("invenioSearchAPI",v),e.module("invenioSearch.factories",[]).factory("invenioSearchRangeFactory",p),e.module("invenioSearch.controllers",[]).controller("invenioSearchController",n),e.module("invenioSearch.directives",[]).directive("invenioSearch",r).directive("invenioSearchBar",t).directive("invenioSearchError",o).directive("invenioSearchCount",c).directive("invenioSearchFacets",s).directive("invenioSearchResults",a).directive("invenioSearchLoading",i).directive("invenioSearchSortOrder",u).directive("invenioSearchSelectBox",h).directive("invenioSearchPagination",l).directive("invenioSearchRange",d),e.module("invenioSearch",["invenioSearch.configuration","invenioSearch.services","invenioSearch.factories","invenioSearch.controllers","invenioSearch.directives"])}(angular);